version: 2.1

jobs:
  build-and-test:
    docker:
      - image: maven:3.9.4-eclipse-temurin-21
      - image: postgres:15
        environment:
          POSTGRES_DB: naturalist
          POSTGRES_USER: ci_user
          POSTGRES_PASSWORD: ci_password

    working_directory: ~/project

    environment:
      # Tell Spring Boot to use the CI Postgres service
      SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/naturalist
      SPRING_DATASOURCE_USERNAME: ci_user
      SPRING_DATASOURCE_PASSWORD: ci_password
      # Optional: disable Flyway/Liquibase or adjust if you use one of them
      # SPRING_LIQUIBASE_ENABLED: "false"
      # SPRING_FLYWAY_ENABLED: "false"

    steps:
      - checkout

      - run:
          name: Debug workspace
          command: |
            echo "Working dir: $(pwd)"
            ls -la
            find . -maxdepth 3 -name pom.xml -print || true

      - run:
          name: Wait for Postgres to accept connections
          command: |
            echo "Waiting for Postgres on localhost:5432..."
            for i in $(seq 1 30); do
              if (echo > /dev/tcp/localhost/5432) >/dev/null 2>&1; then
                echo "Postgres is up"
                break
              fi
              echo "Postgres not ready yet (attempt $i/30)..."
              sleep 2
            done

      - restore_cache:
          keys:
            - maven-repo-{{ checksum "naturalist/pom.xml" }}
            - maven-repo-

      - run:
          name: Build (package)
          command: |
            cd naturalist
            mvn -B -DskipTests clean package

      - run:
          name: Test
          command: |
            cd naturalist
            mvn test

      - save_cache:
          paths:
            - ~/.m2/repository
          key: maven-repo-{{ checksum "naturalist/pom.xml" }}

workflows:
  sample:
    jobs:
      - build-and-test
