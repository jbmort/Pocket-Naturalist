version: 2.1

jobs:
  build-and-test:
    docker:
      - image: maven:3.9.4-eclipse-temurin-21
    # Use the repo root as working dir so checkout places the repo here
    working_directory: ~/project

    steps:
      - checkout

      - run:
          name: Debug workspace
          command: |
            echo "Working dir: $(pwd)"
            ls -la
            find . -maxdepth 3 -name pom.xml -print || true

      - restore_cache:
          keys:
            - maven-repo-{{ checksum "naturalist/pom.xml" }}
            - maven-repo-

      - run:
          name: Build
          command: |
            cd naturalist
            mvn -B -DskipTests clean package

      - run:
          name: Test
          command: |
            cd naturalist
            mvn test

      - save_cache:
          paths:
            - ~/.m2/repository
          key: maven-repo-{{ checksum "naturalist/pom.xml" }}

workflows:
  sample:
    jobs:
      - build-and-test
